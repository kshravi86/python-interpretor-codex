<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>PyDeck Pyodide Host</title>
    <style>
      html, body { margin: 0; padding: 0; }
      body { font-family: -apple-system, system-ui; }
    </style>
  </head>
  <body>
    <script>
      (async function() {
        // Compute base URL for PyodideAssets folder
        const here = new URL(location.href);
        const base = new URL('../PyodideAssets/', here);
        // Load pyodide.js from the assets folder
        const script = document.createElement('script');
        script.src = new URL('pyodide.js', base).toString();
        script.onload = async () => {
          try {
            window.pyodide = await loadPyodide({ indexURL: base.toString() });
            // Buffer stdout/stderr per execution
            window.__pydeckReady = true;
            window.webkit?.messageHandlers?.pyDeck?.postMessage({ type: 'ready' });
          } catch (e) {
            window.webkit?.messageHandlers?.pyDeck?.postMessage({ type: 'error', message: String(e) });
          }
        };
        script.onerror = () => {
          window.webkit?.messageHandlers?.pyDeck?.postMessage({ type: 'error', message: 'Failed to load Pyodide assets. Ensure PyodideAssets is bundled.' });
        };
        document.body.appendChild(script);

        // Define run bridge
        window.pydeckRun = async function(code, id) {
          if (!window.pyodide) {
            window.webkit?.messageHandlers?.pyDeck?.postMessage({ type: 'error', id, message: 'Pyodide not initialized' });
            return;
          }
          let stdout = '';
          let stderr = '';
          const undoOut = window.pyodide.setStdout({
            batched: (s) => { stdout += s; }
          });
          const undoErr = window.pyodide.setStderr({
            batched: (s) => { stderr += s; }
          });
          let codeNum = 0;
          try {
            await window.pyodide.runPythonAsync(code);
          } catch (e) {
            stderr += String(e) + '\n';
            codeNum = 1;
          } finally {
            try { undoOut(); } catch {}
            try { undoErr(); } catch {}
          }
          window.webkit?.messageHandlers?.pyDeck?.postMessage({ type: 'result', id, stdout, stderr, code: codeNum });
        }
      })();
    </script>
  </body>
  </html>

