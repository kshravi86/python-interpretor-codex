<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>PyDeck Pyodide Host</title>
    <style>
      html, body { margin: 0; padding: 0; }
      body { font-family: -apple-system, system-ui; }
    </style>
  </head>
  <body>
    <script>
      (async function() {
        // Compute candidate base URLs depending on where index.html is located.
        const here = new URL(location.href);
        const candidates = [
          new URL('../PyodideAssets/', here), // when index.html is at Pyodide/
          new URL('PyodideAssets/', here)     // when index.html is at bundle root
        ];

        async function tryLoad(base) {
          return new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = new URL('pyodide.js', base).toString();
            script.onload = async () => {
              try {
                window.pyodide = await loadPyodide({ indexURL: base.toString() });
                window.__pydeckReady = true;
                window.webkit?.messageHandlers?.pyDeck?.postMessage({ type: 'ready' });
                resolve();
              } catch (e) { reject(e); }
            };
            script.onerror = () => reject(new Error('Failed to load ' + script.src));
            document.body.appendChild(script);
          });
        }

        let lastErr = null;
        for (const base of candidates) {
          try { await tryLoad(base); lastErr = null; break; }
          catch (e) { lastErr = e; }
        }
        if (lastErr) {
          window.__pydeckError = String(lastErr);
          window.webkit?.messageHandlers?.pyDeck?.postMessage({ type: 'error', message: String(lastErr) });
        }

        // Define run bridge
        window.pydeckRun = async function(code, id) {
          if (!window.pyodide) {
            window.webkit?.messageHandlers?.pyDeck?.postMessage({ type: 'error', id, message: 'Pyodide not initialized' });
            return;
          }
          let stdout = '';
          let stderr = '';
          const undoOut = window.pyodide.setStdout({
            batched: (s) => { stdout += s; }
          });
          const undoErr = window.pyodide.setStderr({
            batched: (s) => { stderr += s; }
          });
          let codeNum = 0;
          try {
            await window.pyodide.runPythonAsync(code);
          } catch (e) {
            stderr += String(e) + '\n';
            codeNum = 1;
          } finally {
            try { undoOut(); } catch {}
            try { undoErr(); } catch {}
          }
          window.webkit?.messageHandlers?.pyDeck?.postMessage({ type: 'result', id, stdout, stderr, code: codeNum });
        }
      })();
    </script>
  </body>
  </html>
